<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Семейное древо</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
input, button { padding: 5px 10px; margin-right: 5px; font-size: 16px; }

/* Основные стили дерева */
.tree-container { margin-top: 20px; }
.person { margin-left: 40px; position: relative; } /* увеличенный отступ */
.person .label { font-weight: bold; cursor: pointer; padding: 2px 5px; border-radius: 4px; display: inline-block; }
.person .label:hover { background-color: #e0f7fa; } /* подсветка при наведении */
.children { margin-left: 30px; display: none; }
.person.expanded > .children { display: block; }

/* Подсветка текущего человека */
.generation-0 > .label { background-color: #ffd54f; }
</style>
</head>
<body>

<h1>Семейное древо</h1>

<label for="personId">Введите ID:</label>
<input type="number" id="personId" value="13" min="1">
<button onclick="loadTree()">Загрузить</button>

<div id="family-tree" class="tree-container"></div>

<script>
async function loadTree() {
  const id = document.getElementById('personId').value;
  const container = document.getElementById('family-tree');
  container.innerHTML = 'Загрузка...';

  try {
    const res = await fetch(`http://127.0.0.1:8000/tree/${id}`, {
      headers: { 'Accept': 'application/json' }
    });
    if (!res.ok) throw new Error('Ошибка при загрузке данных');

    const data = await res.json();
    container.innerHTML = renderPerson(data, 0);

    // Клик по имени для раскрытия ветки
    document.querySelectorAll('.label').forEach(label => {
      label.addEventListener('click', e => {
        e.stopPropagation();
        const parent = label.parentElement;
        parent.classList.toggle('expanded');
      });
    });

  } catch(err) {
    container.innerHTML = `<span style="color:red">${err.message}</span>`;
  }
}

// Рекурсивная функция для генерации дерева
function renderPerson(person, generation) {
  if (!person) return '';

  let html = `<div class="person generation-${generation}">
    <span class="label">${person.first_name} ${person.last_name}</span>`;
  if (person.birth_year || person.death_year) {
    html += ` (${person.birth_year || '?'}${person.death_year ? '–' + person.death_year : ''})`;
  }

  let childrenHtml = '';

  // Родители
  if (person.father || person.mother) {
    childrenHtml += '<div class="children">';
    if (person.father) childrenHtml += `<div><span class="label">Отец:</span> ${renderPerson(person.father, generation + 1)}</div>`;
    if (person.mother) childrenHtml += `<div><span class="label">Мать:</span> ${renderPerson(person.mother, generation + 1)}</div>`;
    childrenHtml += '</div>';
  }

  // Дети
  if (person.children && person.children.length > 0) {
    childrenHtml += '<div class="children"><span class="label">Дети:</span>';
    person.children.forEach(child => {
      childrenHtml += renderPerson(child, generation + 1);
    });
    childrenHtml += '</div>';
  }

  html += childrenHtml + '</div>';
  return html;
}

// Автозагрузка по умолчанию
loadTree();
</script>

</body>
</html>
