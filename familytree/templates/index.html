<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Семейное древо</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
input, button, select { padding: 5px 10px; font-size: 16px; margin-right: 5px; }

.tree-container { margin-top: 20px; }

/* Основные стили дерева */
.person { margin-left: 40px; position: relative; }
.person .label { font-weight: bold; cursor: pointer; padding: 2px 5px; border-radius: 4px; display: inline-block; }
.person .label:hover { background-color: #e0f7fa; } /* подсветка при наведении */
.children { margin-left: 30px; display: none; }
.person.expanded > .children { display: block; }

/* Подсветка выбранного человека */
.generation-0 > .label { background-color: #ffd54f; }
</style>
</head>
<body>

<h1>Семейное древо</h1>

<label for="personSelect">Выберите человека:</label>
<select id="personSelect">
  <option value="">-- Выберите --</option>
</select>
<button onclick="loadSelectedTree()">Показать дерево</button>

<div id="family-tree" class="tree-container"></div>

<script>
async function loadPeople() {
  try {
    const res = await fetch('http://127.0.0.1:8000/person/', { headers: { 'Accept': 'application/json' } });
    const people = await res.json();
    const select = document.getElementById('personSelect');
    people.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.text = `${p.first_name} ${p.last_name}${p.birth_year ? ' (' + p.birth_year + ')' : ''}`;
      select.appendChild(option);
    });
  } catch(err) {
    console.error('Ошибка при загрузке людей:', err);
  }
}

// Загружаем дерево выбранного человека
async function loadSelectedTree() {
  const select = document.getElementById('personSelect');
  const id = select.value;
  if (!id) return;

  const container = document.getElementById('family-tree');
  container.innerHTML = 'Загрузка...';

  try {
    const res = await fetch(`http://127.0.0.1:8000/tree/${id}`, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('Ошибка при загрузке дерева');
    const data = await res.json();
    container.innerHTML = renderPerson(data, 0);

    // Добавляем кликабельность на имя/фамилию
    document.querySelectorAll('.label').forEach(label => {
      label.addEventListener('click', e => {
        e.stopPropagation();
        const parent = label.parentElement;
        parent.classList.toggle('expanded');
      });
    });
  } catch(err) {
    container.innerHTML = `<span style="color:red">${err.message}</span>`;
  }
}

// Рекурсивная функция для генерации HTML дерева
function renderPerson(person, generation) {
  if (!person) return '';

  let html = `<div class="person generation-${generation}">
    <span class="label">${person.first_name} ${person.last_name}</span>`;
  if (person.birth_year || person.death_year) {
    html += ` (${person.birth_year || '?'}${person.death_year ? '–' + person.death_year : ''})`;
  }

  let childrenHtml = '';

  // Родители
  if (person.father || person.mother) {
    childrenHtml += '<div class="children">';
    if (person.father) childrenHtml += `<div><span class="label">Отец:</span> ${renderPerson(person.father, generation + 1)}</div>`;
    if (person.mother) childrenHtml += `<div><span class="label">Мать:</span> ${renderPerson(person.mother, generation + 1)}</div>`;
    childrenHtml += '</div>';
  }

  // Дети
  if (person.children && person.children.length > 0) {
    childrenHtml += '<div class="children"><span class="label">Дети:</span>';
    person.children.forEach(child => {
      childrenHtml += renderPerson(child, generation + 1);
    });
    childrenHtml += '</div>';
  }

  html += childrenHtml + '</div>';
  return html;
}

loadPeople();
</script>

</body>
</html>
