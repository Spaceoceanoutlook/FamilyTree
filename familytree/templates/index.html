<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Генеалогическое древо</title>
<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: linear-gradient(to bottom right, #f0f8ff, #e6f7ff);
}
input, button, select { padding: 5px 10px; font-size: 16px; margin-right: 5px; }

/* Контейнер дерева */
.tree-container { margin-top: 20px; }

/* Основные стили карточек людей */
.person {
    margin-left: 50px;
    position: relative;
    margin-bottom: 5px;
}
.person .card {
    padding: 5px 10px;
    border-radius: 6px;
    border: 1px solid #ddd;
    background-color: #fff;
    display: inline-block;
    transition: background-color 0.2s;
}
.person .card:hover {
    background-color: #e0f7fa;
}
.label {
    font-weight: bold;
    cursor: pointer;
}

/* Дети и родители скрыты по умолчанию */
.children { margin-left: 30px; display: none; }
.person.expanded > .children { display: block; }

/* Цвет для выбранного человека */
.generation-0 > .card { background-color: #ffe082; }

/* Подписи родителей и детей */
.person .role { font-weight: normal; color: #555; margin-right: 5px; }

</style>
</head>
<body>

<h1>Генеалогическое древо</h1>

<label for="personSelect">Выберите человека:</label>
<select id="personSelect">
  <option value="">-- Выберите --</option>
</select>
<button onclick="loadSelectedTree()">Показать дерево</button>

<div id="family-tree" class="tree-container"></div>

<script>
async function loadPeople() {
  try {
    const res = await fetch('/person/', { headers: { 'Accept': 'application/json' } });
    const people = await res.json();
    const select = document.getElementById('personSelect');
    people.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.text = `${p.first_name} ${p.last_name}${p.birth_year ? ' (' + p.birth_year + ')' : ''}`;
      select.appendChild(option);
    });
  } catch(err) {
    console.error('Ошибка при загрузке людей:', err);
  }
}

async function loadSelectedTree() {
  const select = document.getElementById('personSelect');
  const id = select.value;
  if (!id) return;

  const container = document.getElementById('family-tree');
  container.innerHTML = 'Загрузка...';

  try {
    const res = await fetch(`/tree/${id}`, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('Ошибка при загрузке дерева');
    const data = await res.json();
    container.innerHTML = renderPerson(data, 0);

    document.querySelectorAll('.label').forEach(label => {
      label.addEventListener('click', e => {
        e.stopPropagation();
        const parent = label.closest('.person');
        parent.classList.toggle('expanded');
      });
    });
  } catch(err) {
    container.innerHTML = `<span style="color:red">${err.message}</span>`;
  }
}

function renderPerson(person, generation) {
  if (!person) return '';

  let labelText = `${person.first_name} ${person.last_name}`;
  if (person.birth_year || person.death_year) {
    labelText += ` (${person.birth_year || '?'}${person.death_year ? '–' + person.death_year : ''})`;
  }

  let html = `<div class="person generation-${generation}">
      <div class="card">
        <span class="label">${labelText}</span>
      </div>`;

  let childrenHtml = '';

  // Родители
  if (person.father || person.mother) {
    childrenHtml += '<div class="children">';
    if (person.father) childrenHtml += `<div><span class="role">Отец:</span>${renderPerson(person.father, generation + 1)}</div>`;
    if (person.mother) childrenHtml += `<div><span class="role">Мать:</span>${renderPerson(person.mother, generation + 1)}</div>`;
    childrenHtml += '</div>';
  }

  // Дети
  if (person.children && person.children.length > 0) {
    childrenHtml += '<div class="children"><span class="role">Дети:</span>';
    person.children.forEach(child => {
      childrenHtml += renderPerson(child, generation + 1);
    });
    childrenHtml += '</div>';
  }

  html += childrenHtml + '</div>';
  return html;
}

loadPeople();
</script>

</body>
</html>
